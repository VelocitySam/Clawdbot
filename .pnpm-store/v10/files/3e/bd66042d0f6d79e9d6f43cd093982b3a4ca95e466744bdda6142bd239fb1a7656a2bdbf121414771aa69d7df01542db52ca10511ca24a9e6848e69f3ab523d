(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const k of i.addedNodes)k.tagName==="LINK"&&k.rel==="modulepreload"&&s(k)}).observe(document,{childList:!0,subtree:!0});function r(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=r(n);fetch(n.href,i)}})();const N=15e3,b=document.querySelector("#status-log"),u=document.querySelector("#enable-btn"),g=document.querySelector("#kpi-value"),h=document.querySelector("#badge-status"),A=[...document.querySelectorAll('[data-demo="pulse"]')],T=document.querySelector("#mock-chart"),p=document.querySelector("#tls-status"),x=document.querySelector("#tls-status-message"),v=document.querySelector("#tls-open"),E=document.querySelector("#tls-retry"),L=document.querySelector("#session-chip"),I=document.querySelector("#session-prefix"),q=document.querySelector("#session-name");let a=null,c=null,S=null;const O=[];let m=null;function f(e){u&&(u.disabled=!e)}function d(e,t){if(!(!p||!x)){if(p.dataset.state=e,x.textContent=t,e==="trusted"){p.style.display="none",f(!0);return}p.style.display="flex",f(!1)}}async function y(e={}){if(m&&!e.force)return await m;m=(async()=>{d("checking","Checking daemon TLS status…");try{const t=await fetch("/api/sweetlink/status",{method:"GET",headers:{Accept:"application/json"},cache:"no-store"});if(!t.ok){d("unreachable",`Daemon status request failed (${t.status}).`);return}const r=await t.json();if(!r.reachable){const s=r.message?` (${r.message})`:"";d("unreachable",`SweetLink daemon is offline. Start it with \`pnpm sweetlink:daemon\`${s}.`);return}if(!r.tlsTrusted){const s=r.message?` (${r.message})`:"";d("untrusted",`Browser has not trusted the SweetLink certificate yet. Open the daemon URL and accept the certificate${s}.`);return}d("trusted","Daemon TLS certificate is trusted.")}catch(t){d("unreachable",`Unable to verify daemon TLS status${t instanceof Error?`: ${t.message}`:""}`)}})();try{await m}finally{m=null}}function o(e){if(!b)return;const t=new Date().toISOString();b.textContent=`${b.textContent??""}
[${t}] ${e}`.trim()}function l(e,t,r){if(!L||!q||!I)return;L.dataset.state=e;const s=e==="inactive";L.setAttribute("aria-hidden",s?"true":"false");let n=r;n||(e==="active"?n="Connected as":e==="pending"?n="Awaiting CLI":n="CLI Session"),I.textContent=n,q.textContent=t??"—"}function P(e,t){const r={id:crypto.randomUUID(),timestamp:Date.now(),level:e,args:t};(a==null?void 0:a.readyState)===WebSocket.OPEN&&c?M([r]):O.push(r)}function M(e){!a||a.readyState!==WebSocket.OPEN||!c||e.length===0||a.send(JSON.stringify({kind:"console",sessionId:c,events:e}))}function R(){const e=["log","info","warn","error","debug"];for(const t of e){const r=console[t].bind(console);console[t]=(...s)=>{r(...s);try{P(t,s)}catch{}}}}const w={updateKpi(e){if(!g)return null;const t=Math.max(0,Math.min(100,Number(e)||0));return g.textContent=`${t.toFixed(0)}%`,g.classList.add("highlight"),globalThis.setTimeout(()=>g.classList.remove("highlight"),600),o(`KPI value updated to ${t.toFixed(0)}%.`),t},toggleBadge(){if(!h)return null;const t=(h.textContent??"").trim()==="beta"?"stable":"beta";return h.textContent=t,h.dataset.state=t,o(`Badge toggled to "${t}".`),t},pulseCard(){const e=document.querySelector("#screenshot-card");return e?(e.classList.add("pulse"),globalThis.setTimeout(()=>e.classList.remove("pulse"),800),o("Screenshot card pulse animation triggered."),!0):!1},randomizeChart(){if(!T)return!1;const e=[...T.querySelectorAll(".bar")];for(const t of e){const r=35+Math.random()*60;t.style.height=`${r}%`}return o("Chart bars randomized."),!0}};globalThis.demo=w;async function D(){o("Requesting SweetLink handshake…");const e=await fetch("/api/sweetlink/handshake",{method:"POST"});if(!e.ok){const t=await e.text();throw new Error(`Handshake failed (${e.status}): ${t}`)}return await e.json()}function F(){!c||!a||($(),S=globalThis.setInterval(()=>{(a==null?void 0:a.readyState)===WebSocket.OPEN&&c&&a.send(JSON.stringify({kind:"heartbeat",sessionId:c}))},N*.8))}function $(){S!==null&&(clearInterval(S),S=null)}function C(e){!a||a.readyState!==WebSocket.OPEN||!c||a.send(JSON.stringify({kind:"commandResult",sessionId:c,result:e}))}async function H(e){if(typeof e.code!="string")throw new TypeError("SweetLink runScript command is missing code.");const t=(async()=>{}).constructor;return await new t("demo",`"use strict"; return (${e.code});`).call(globalThis,w)}async function U(e){const{command:t}=e;if(!t||typeof t!="object")return;const r=performance.now();try{switch(t.type){case"runScript":{const s=await H(t);C({ok:!0,commandId:t.id,durationMs:Math.round(performance.now()-r),data:s});return}case"navigate":{const s=t;if(typeof s.target!="string"||s.target.length===0)throw new TypeError("Missing navigate target");globalThis.location.assign(s.target),C({ok:!0,commandId:s.id,durationMs:Math.round(performance.now()-r),data:globalThis.location.href});return}default:throw new Error(`Command "${String(t.type)}" is not implemented in the demo client.`)}}catch(s){const n=s instanceof Error?s.message:String(s);C({ok:!1,commandId:t.id,durationMs:Math.round(performance.now()-r),error:n,stack:s instanceof Error&&s.stack?s.stack:void 0})}}function W(e){if(!(e!=null&&e.data))return;let t;try{t=JSON.parse(e.data)}catch(r){o(`Received invalid message: ${r instanceof Error?r.message:String(r)}`);return}switch(t.kind){case"command":{U(t);break}case"metadata":{const r=t.codename;o(`CLI attached as "${r}".`),l("active",r,"Connected as");break}case"disconnect":{o(`Daemon requested disconnect: ${t.reason??"unknown reason"}`);break}default:{const r=t.kind;o(`Received message: ${typeof r=="string"?r:"unknown"}`);break}}}async function J(e){return await new Promise((t,r)=>{const s=new WebSocket(e.socketUrl);a=s,c=e.sessionId,s.addEventListener("open",()=>{o("Connected. Registering session with daemon…");const n={kind:"register",token:e.sessionToken,sessionId:e.sessionId,url:globalThis.location.href,title:document.title,userAgent:navigator.userAgent,topOrigin:globalThis.location.origin};s.send(JSON.stringify(n)),M(O.splice(0)),F(),d("trusted","Daemon TLS certificate is trusted."),t()}),s.addEventListener("message",n=>W(n)),s.addEventListener("close",n=>{o(`Socket closed (${n.code}${n.reason?`: ${n.reason}`:""}).`),$(),l("inactive"),f(!0)}),s.addEventListener("error",n=>{const i=n instanceof ErrorEvent?n.message??"unknown error":"unknown error";if(o(`WebSocket error: ${i}`),$(),l("inactive"),f(!0),y({force:!0}),n instanceof ErrorEvent&&n.error instanceof Error){r(n.error);return}r(new Error(i))})})}async function K(){if(u){f(!1),l("pending","Requesting session…","SweetLink");try{const e=await D();o(`Handshake granted. Session ${e.sessionId}. Connecting to ${e.socketUrl}…`),l("pending",`Session ${e.sessionId.slice(0,8)}`,"Awaiting CLI"),await J(e),o('SweetLink session registered. Run "pnpm sweetlink sessions" to inspect.'),w.randomizeChart()}catch(e){const t=e instanceof Error?e.message:String(e);o(`Failed to enable SweetLink: ${t}`),f(!0),l("inactive"),y({force:!0})}}}R();for(const e of A)e.addEventListener("click",()=>{w.pulseCard()});u==null||u.addEventListener("click",()=>{o("Starting SweetLink activation…"),K()});v==null||v.addEventListener("click",()=>{window.open("https://localhost:4455","_blank","noopener")});E==null||E.addEventListener("click",()=>{y({force:!0})});y();l("inactive");
