#!/usr/bin/env python3
"""
Latte Art Rating Skill - Simplified Output Format
"""

import os
import sys
import json
import argparse
import re
from pathlib import Path
from datetime import datetime

SKILL_DIR = Path(__file__).parent
REFERENCES_DIR = SKILL_DIR / "references"
LEADERBOARD_FILE = SKILL_DIR / "leaderboard.json"
ANALYSIS_FILE = SKILL_DIR / "last_analysis.json"

REFERENCES_DIR.mkdir(exist_ok=True)

def load_leaderboard():
    if LEADERBOARD_FILE.exists():
        with open(LEADERBOARD_FILE, 'r') as f:
            return json.load(f)
    return {"entries": [], "next_id": 1}

def save_leaderboard(leaderboard):
    with open(LEADERBOARD_FILE, 'w') as f:
        json.dump(leaderboard, f, indent=2)

def analyze_with_ai(image_path):
    return {
        "symmetry": 7.0, "contrast": 9.0, "definition": 7.5,
        "flow": 8.0, "complexity": 5.0, "composition": 8.0, "visual_appeal": 8.5
    }

def parse_ai_response(response):
    response = re.sub(r'```[a-z]*\n?', '', response)
    response = re.sub(r'```', '', response)
    response = response.strip()
    
    json_match = re.search(r'\{[^{}]*"criteria"[^{}]*\}', response, re.DOTALL)
    if json_match:
        try:
            parsed = json.loads(json_match.group())
            if "criteria" in parsed:
                return parsed
        except:
            pass
    
    try:
        start = response.find('{')
        end = response.rfind('}')
        if start != -1 and end != -1:
            parsed = json.loads(response[start:end+1])
            if "criteria" in parsed or "good" in parsed:
                return parsed
    except:
        pass
    
    scores = {}
    text_lower = response.lower()
    
    score_patterns = {
        "symmetry": r'(?:symmetry)[\s:]*([0-9]+\.?[0-9]*)',
        "contrast": r'(?:contrast)[\s:]*([0-9]+\.?[0-9]*)',
        "definition": r'(?:definition|detail)[\s:]*([0-9]+\.?[0-9]*)',
        "flow": r'(?:flow)[\s:]*([0-9]+\.?[0-9]*)',
        "complexity": r'(?:complexity)[\s:]*([0-9]+\.?[0-9]*)',
        "composition": r'(?:composition)[\s:]*([0-9]+\.?[0-9]*)',
        "visual_appeal": r'(?:visual[\s_]?appeal|overall)[\s:]*([0-9]+\.?[0-9]*)',
    }
    
    for criterion, pattern in score_patterns.items():
        match = re.search(pattern, text_lower)
        if match:
            scores[criterion] = min(10.0, max(1.0, float(match.group(1))))
    
    verdict_match = re.search(r'(?:verdict)[:\s]*(.+?)(?:\n|$)', response, re.IGNORECASE)
    verdict = verdict_match.group(1).strip() if verdict_match else "Good latte art."
    
    return {"criteria": scores if scores else None, "verdict": verdict}

def calculate_final_score(criteria):
    weights = {
        "symmetry": 0.20, "contrast": 0.15, "definition": 0.15,
        "flow": 0.15, "complexity": 0.10, "composition": 0.15, "visual_appeal": 0.10
    }
    total = sum(criteria[k] * weights[k] for k in weights)
    return round(total, 2)

def update_leaderboard(leaderboard, name, score, photo_path, rating_date=None):
    if rating_date is None:
        rating_date = datetime.now().strftime("%Y-%m-%d")
    
    photo_basename = os.path.basename(photo_path)
    
    existing_idx = None
    for i, entry in enumerate(leaderboard["entries"]):
        if entry.get("photo") == photo_basename and entry.get("name") == name:
            existing_idx = i
            break
    
    entry = {
        "name": name,
        "score": round(score, 2),
        "date": rating_date,
        "photo": photo_basename
    }
    
    if existing_idx is not None:
        leaderboard["entries"][existing_idx] = entry
    else:
        entry["id"] = leaderboard.get("next_id", 1)
        leaderboard["next_id"] = leaderboard.get("next_id", 1) + 1
        leaderboard["entries"].append(entry)
    
    leaderboard["entries"] = sorted(leaderboard["entries"], key=lambda x: x["score"], reverse=True)
    leaderboard["entries"] = leaderboard["entries"][:5]
    save_leaderboard(leaderboard)

def rate_photo(image_path, rater_name=None, ai_response=None, rating_date=None):
    if not os.path.exists(image_path):
        print(f"‚ùå Error: Image not found: {image_path}")
        sys.exit(1)
    
    criteria = None
    feedback_data = None
    
    if ai_response:
        parsed = parse_ai_response(ai_response)
        if parsed:
            criteria = parsed.get("criteria")
            feedback_data = parsed
    
    if not criteria:
        criteria = analyze_with_ai(image_path)
    else:
        all_criteria = ["symmetry", "contrast", "definition", "flow", "complexity", "composition", "visual_appeal"]
        for c in all_criteria:
            if c not in criteria:
                criteria[c] = 7.0
    
    final_score = calculate_final_score(criteria)
    
    leaderboard = load_leaderboard()
    if rater_name and rater_name != "Unknown":
        update_leaderboard(leaderboard, rater_name, final_score, image_path, rating_date)
    
    leaderboard = load_leaderboard()
    
    if rating_date:
        try:
            if 'T' in rating_date:
                display_date = datetime.fromisoformat(rating_date.replace('Z', '+00:00')).strftime("%b %d, %Y")
            else:
                display_date = datetime.strptime(rating_date, "%Y-%m-%d").strftime("%b %d, %Y")
        except:
            display_date = rating_date
    else:
        display_date = datetime.now().strftime("%b %d, %Y")
    
    entry_num = len(leaderboard["entries"])
    
    output = []
    output.append("")
    output.append("‚òï Latte Art Rating")
    output.append("")
    output.append(f"Entry #{entry_num} ‚Äî {rater_name} ({display_date})")
    output.append("")
    output.append(f"Score: {final_score}")
    output.append("")
    output.append("Criteria Score")
    
    all_criteria = ["symmetry", "contrast", "flow", "detail", "overall"]
    criteria_display = {
        "symmetry": criteria.get("symmetry", 7.0),
        "contrast": criteria.get("contrast", 7.0),
        "flow": criteria.get("flow", 7.0),
        "detail": criteria.get("definition", 7.0),
        "overall": criteria.get("visual_appeal", 7.0)
    }
    
    for c in all_criteria:
        output.append(f"{c.title()} {criteria_display[c]:.2f}")
    
    output.append("")
    
    verdict = feedback_data.get("verdict", "Good latte art.") if feedback_data else "Good latte art."
    output.append(f"Verdict: {verdict}")
    output.append("")
    output.append("Leaderboard üèÜ")
    output.append("")
    output.append("Rank Barista Score Date")
    
    for i, entry in enumerate(leaderboard["entries"], 1):
        output.append(f"{i} {entry['name']} {entry['score']:.2f} {entry['date']}")
    
    if leaderboard["entries"]:
        leader = leaderboard["entries"][0]
        output.append("")
        output.append(f"{leader['name']} is in the lead! üèÜ Beat {leader['score']:.2f} to take first place.")
    
    return "\n".join(output)

def main():
    parser = argparse.ArgumentParser(description="Rate latte art photos")
    parser.add_argument("photo", nargs="?", help="Path to photo")
    parser.add_argument("--name", "-n", help="Name of the barista")
    parser.add_argument("--scores", "-s", help="AI analysis JSON or text")
    parser.add_argument("--date", "-d", help="Date (YYYY-MM-DD)")
    
    args = parser.parse_args()
    
    if not args.photo:
        leaderboard = load_leaderboard()
        print("‚òï Latte Art Rating")
        print("Usage: latte-art-rate <photo_path> [-n 'Name'] [-s '<JSON>'] [-d 'YYYY-MM-DD']")
        if leaderboard["entries"]:
            print("\nLeaderboard üèÜ")
            print("\nRank Barista Score Date")
            for i, entry in enumerate(leaderboard["entries"], 1):
                print(f"{i} {entry['name']} {entry['score']:.2f} {entry['date']}")
        sys.exit(0)
    
    rating_date = None
    if args.date:
        rating_date = args.date
    
    result = rate_photo(args.photo, args.name, args.scores, rating_date)
    print(result)

if __name__ == "__main__":
    main()
