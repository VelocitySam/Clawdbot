#!/usr/bin/env python3
"""
Latte Art Rating Skill
Analyzes latte art photos with AI and provides detailed scoring breakdown
"""

import os
import sys
import json
import argparse
import shutil
from pathlib import Path
from datetime import datetime

SKILL_DIR = Path(__file__).parent
REFERENCES_DIR = SKILL_DIR / "references"
LEADERBOARD_FILE = SKILL_DIR / "leaderboard.json"
ANALYSIS_FILE = SKILL_DIR / "last_analysis.json"

# Ensure directories exist
REFERENCES_DIR.mkdir(exist_ok=True)

def load_leaderboard():
    """Load leaderboard from file"""
    if LEADERBOARD_FILE.exists():
        with open(LEADERBOARD_FILE, 'r') as f:
            return json.load(f)
    return {"entries": []}

def save_leaderboard(leaderboard):
    """Save leaderboard to file"""
    with open(LEADERBOARD_FILE, 'w') as f:
        json.dump(leaderboard, f, indent=2)

def analyze_with_ai(image_path):
    """
    Use AI to analyze the latte art image and return detailed scores
    """
    # This will be called via the image tool externally
    # For now, save the path for external analysis
    return {
        "symmetry": 7.0,
        "contrast": 9.0,
        "definition": 7.5,
        "flow": 8.0,
        "complexity": 5.0,
        "composition": 8.0,
        "visual_appeal": 8.5
    }

def calculate_final_score(criteria):
    """Calculate weighted final score"""
    weights = {
        "symmetry": 0.20,
        "contrast": 0.15,
        "definition": 0.15,
        "flow": 0.15,
        "complexity": 0.10,
        "composition": 0.15,
        "visual_appeal": 0.10
    }
    
    total = sum(criteria[k] * weights[k] for k in weights)
    return round(total, 2)

def get_verdict(score):
    """Get text verdict based on score (strict scale)"""
    if score >= 10.0:
        return "WORLD CHAMPION. Flawless. Magazine cover quality."
    elif score >= 9.0:
        return "Exceptional. Competition finalist level."
    elif score >= 8.0:
        return "Excellent. Professional barista quality."
    elif score >= 7.0:
        return "Good. Strong home barista skills."
    elif score >= 6.0:
        return "Average. Decent, but obvious room for improvement."
    elif score >= 5.0:
        return "Below Average. Basic technique issues."
    elif score >= 4.0:
        return "Poor. Significant problems with execution."
    elif score >= 3.0:
        return "Very Poor. Little skill demonstrated."
    elif score >= 2.0:
        return "Failed. Barely recognizable as latte art."
    else:
        return "No Latte Art. Complete failure."

def format_score_bar(score, max_score=10, length=16):
    """Create a visual score bar"""
    filled = int((score / max_score) * length)
    return "â–ˆ" * filled + "â–‘" * (length - filled)

def update_leaderboard(leaderboard, name, score, photo_path):
    """Update leaderboard with new entry"""
    entry = {
        "name": name,
        "score": score,
        "date": datetime.now().strftime("%Y-%m-%d %H:%M"),
        "photo": os.path.basename(photo_path)
    }
    
    leaderboard["entries"].append(entry)
    
    # Sort by score descending
    leaderboard["entries"] = sorted(
        leaderboard["entries"], 
        key=lambda x: x["score"], 
        reverse=True
    )
    
    # Keep only top 5
    leaderboard["entries"] = leaderboard["entries"][:5]
    
    save_leaderboard(leaderboard)

def display_leaderboard(leaderboard):
    """Display the leaderboard"""
    if not leaderboard["entries"]:
        return ""
    
    output = []
    output.append("ğŸ† TOP 5 LEADERBOARD")
    output.append("â”€" * 44)
    
    for i, entry in enumerate(leaderboard["entries"], 1):
        medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£"][i-1]
        output.append(f" {medal} {entry['name']:15} {entry['score']:.2f}/10  {entry['date']}")
    
    return "\n".join(output)

def save_analysis(analysis, image_path):
    """Save the last analysis for reference"""
    with open(ANALYSIS_FILE, 'w') as f:
        json.dump({
            "image": os.path.basename(image_path),
            "timestamp": datetime.now().isoformat(),
            "analysis": analysis
        }, f, indent=2)

def rate_photo(image_path, rater_name=None, ai_analysis=None):
    """Main function to rate a latte art photo"""
    
    if not os.path.exists(image_path):
        print(f"âŒ Error: Image not found: {image_path}")
        sys.exit(1)
    
    # Use AI analysis if provided, otherwise use defaults
    if ai_analysis:
        criteria = ai_analysis.get("criteria", {})
    else:
        criteria = analyze_with_ai(image_path)
    
    final_score = calculate_final_score(criteria)
    verdict = get_verdict(final_score)
    
    # Update leaderboard if named
    leaderboard = load_leaderboard()
    if rater_name and rater_name != "Unknown":
        update_leaderboard(leaderboard, rater_name, final_score, image_path)
    
    leaderboard = load_leaderboard()
    
    # Build output
    output = []
    output.append("â˜• LATTE ART RATING")
    output.append("â•" * 44)
    output.append(f"ğŸ“¸ Photo: {os.path.basename(image_path)}")
    if rater_name and rater_name != "Unknown":
        output.append(f"ğŸ‘¤ Barista: {rater_name}")
    output.append(f"ğŸ“… Rated: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    output.append("")
    output.append("CRITERIA BREAKDOWN")
    output.append("â”€" * 44)
    
    for criterion, score in criteria.items():
        bar = format_score_bar(score)
        output.append(f" {criterion.title():16} {bar} {score:.1f}/10")
    
    output.append("â”€" * 44)
    output.append("")
    output.append(f"ğŸ† FINAL SCORE: {final_score:.2f}/10")
    output.append("")
    output.append("ğŸ“ˆ VERDICT")
    output.append(f"   {verdict}")
    
    # Add detailed feedback if available
    if ai_analysis and "feedback" in ai_analysis:
        output.append("")
        output.append("DETAILED FEEDBACK:")
        output.append("")
        output.append("âœ… What's Good:")
        for line in ai_analysis.get("good", []):
            output.append(f"   â€¢ {line}")
        output.append("")
        output.append("âš ï¸ What to Improve:")
        for line in ai_analysis.get("improve", []):
            output.append(f"   â€¢ {line}")
        output.append("")
        output.append("ğŸ’¡ Tips:")
        for line in ai_analysis.get("tips", []):
            output.append(f"   â€¢ {line}")
    
    # Add leaderboard
    output.append("")
    output.append(display_leaderboard(leaderboard))
    
    # Save analysis
    save_analysis({"criteria": criteria, "feedback": ai_analysis} if ai_analysis else {"criteria": criteria}, image_path)
    
    return "\n".join(output)

def main():
    parser = argparse.ArgumentParser(description="Rate latte art photos")
    parser.add_argument("photo", nargs="?", help="Path to photo")
    parser.add_argument("--json", action="store_true", help="Output as JSON")
    parser.add_argument("--name", "-n", help="Name of the barista")
    parser.add_argument("--scores", "-s", help="JSON scores from AI analysis")
    
    args = parser.parse_args()
    
    if not args.photo:
        # Interactive mode
        print("â˜• Latte Art Rating Skill")
        print("Usage: latte-art-rate <photo_path> [-n 'Barista Name']")
        print("")
        print("Provide a photo path to rate your latte art!")
        
        # Show current leaderboard
        leaderboard = load_leaderboard()
        if leaderboard["entries"]:
            print(display_leaderboard(leaderboard))
        sys.exit(0)
    
    # Parse AI analysis if provided
    ai_analysis = None
    if args.scores:
        try:
            ai_analysis = json.loads(args.scores)
        except:
            pass
    
    result = rate_photo(args.photo, args.name, ai_analysis)
    print(result)

if __name__ == "__main__":
    main()
