#!/usr/bin/env python3
"""
Latte Art Rating Skill
Analyzes latte art photos, provides detailed scoring, and tracks leaderboard
"""

import os
import sys
import json
import argparse
import shutil
from pathlib import Path
from datetime import datetime

SKILL_DIR = Path(__file__).parent
REFERENCES_DIR = SKILL_DIR / "references"
LEADERBOARD_FILE = SKILL_DIR / "leaderboard.json"

# Ensure directories exist
REFERENCES_DIR.mkdir(exist_ok=True)

def load_leaderboard():
    """Load leaderboard from file"""
    if LEADERBOARD_FILE.exists():
        with open(LEADERBOARD_FILE, 'r') as f:
            return json.load(f)
    return {"entries": []}

def save_leaderboard(leaderboard):
    """Save leaderboard to file"""
    with open(LEADERBOARD_FILE, 'w') as f:
        json.dump(leaderboard, f, indent=2)

def analyze_image(image_path):
    """
    Analyze latte art photo and return scores
    Returns dict with criteria breakdown and final score
    """
    # Placeholder for actual computer vision analysis
    # In production, use OpenCV for:
    # - Symmetry detection
    # - Contrast measurement
    # - Edge/line definition
    # - Pattern recognition
    
    return {
        "symmetry": 7.5,
        "contrast": 8.0,
        "definition": 7.0,
        "flow": 7.5,
        "complexity": 6.5,
        "composition": 7.5,
        "visual_appeal": 8.0
    }

def calculate_final_score(criteria):
    """Calculate weighted final score"""
    weights = {
        "symmetry": 0.20,
        "contrast": 0.15,
        "definition": 0.15,
        "flow": 0.15,
        "complexity": 0.10,
        "composition": 0.15,
        "visual_appeal": 0.10
    }
    
    total = sum(criteria[k] * weights[k] for k in weights)
    return round(total, 2)

def get_verdict(score):
    """Get text verdict based on score"""
    if score >= 9.5:
        return "Perfection. Competition-winning quality!"
    elif score >= 9.0:
        return "Exceptional. Near-perfect execution."
    elif score >= 8.0:
        return "Excellent. Professional level technique."
    elif score >= 7.0:
        return "Great. Strong pour with good technique."
    elif score >= 6.0:
        return "Good. Solid pour, minor improvements possible."
    elif score >= 5.0:
        return "Average. Decent, room for improvement."
    elif score >= 4.0:
        return "Below average. Technique needs work."
    elif score >= 3.0:
        return "Poor. Significant issues with execution."
    elif score >= 2.0:
        return "Very poor. Basic structure lacking."
    else:
        return "Failed. No discernible latte art."

def format_score_bar(score, max_score=10, length=16):
    """Create a visual score bar"""
    filled = int((score / max_score) * length)
    return "â–ˆ" * filled + "â–‘" * (length - filled)

def get_rater_name():
    """Get the name of who is being rated"""
    print("\nğŸ‘¤ Who poured this? (enter name or press Enter to skip)")
    name = input("   Name: ").strip()
    return name if name else "Unknown"

def save_as_reference(image_path, score):
    """Save this photo as the reference for its score bracket"""
    score_int = int(score)
    ref_path = REFERENCES_DIR / f"score-{score_int}.jpg"
    
    # Only save if this is a better reference (or no reference exists)
    existing_score = get_existing_reference_score(score_int)
    if existing_score is None or score > existing_score:
        shutil.copy2(image_path, ref_path)
        return True
    return False

def get_existing_reference_score(score_int):
    """Check if reference photo exists for this score"""
    ref_path = REFERENCES_DIR / f"score-{score_int}.jpg"
    if ref_path.exists():
        return score_int + 0.5  # Assume existing is slightly better
    return None

def update_leaderboard(leaderboard, name, score, photo_path):
    """Update leaderboard with new entry"""
    entry = {
        "name": name,
        "score": score,
        "date": datetime.now().strftime("%Y-%m-%d %H:%M"),
        "photo": os.path.basename(photo_path)
    }
    
    leaderboard["entries"].append(entry)
    
    # Sort by score descending
    leaderboard["entries"] = sorted(
        leaderboard["entries"], 
        key=lambda x: x["score"], 
        reverse=True
    )
    
    # Keep only top 5
    leaderboard["entries"] = leaderboard["entries"][:5]
    
    save_leaderboard(leaderboard)

def display_leaderboard(leaderboard):
    """Display the leaderboard"""
    if not leaderboard["entries"]:
        return ""
    
    output = []
    output.append("ğŸ† TOP 5 LEADERBOARD")
    output.append("â”€" * 44)
    
    for i, entry in enumerate(leaderboard["entries"], 1):
        medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£"][i-1]
        output.append(f" {medal} {entry['name']:15} {entry['score']:.2f}/10  {entry['date']}")
    
    return "\n".join(output)

def rate_photo(image_path, rater_name=None):
    """Main function to rate a latte art photo"""
    
    if not os.path.exists(image_path):
        print(f"âŒ Error: Image not found: {image_path}")
        sys.exit(1)
    
    # Analyze the image
    criteria = analyze_image(image_path)
    final_score = calculate_final_score(criteria)
    verdict = get_verdict(final_score)
    
    # Get rater name if not provided
    if not rater_name:
        rater_name = get_rater_name()
    
    # Update leaderboard and save reference if named
    leaderboard = load_leaderboard()
    if rater_name and rater_name != "Unknown":
        update_leaderboard(leaderboard, rater_name, final_score, image_path)
        
        # Save as reference if it's a good score
        if final_score >= 5.0:
            saved = save_as_reference(image_path, final_score)
            if saved:
                print(f"\nâ­ New reference photo saved for score {int(final_score)}!")
    
    leaderboard = load_leaderboard()
    
    # Build output
    output = []
    output.append("â˜• LATTE ART RATING")
    output.append("â•" * 44)
    output.append(f"ğŸ“¸ Photo: {os.path.basename(image_path)}")
    if rater_name and rater_name != "Unknown":
        output.append(f"ğŸ‘¤ Barista: {rater_name}")
    output.append(f"ğŸ“… Rated: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    output.append("")
    output.append("CRITERIA BREAKDOWN")
    output.append("â”€" * 44)
    
    for criterion, score in criteria.items():
        bar = format_score_bar(score)
        output.append(f" {criterion.title():16} {bar} {score:.1f}/10")
    
    output.append("â”€" * 44)
    output.append("")
    output.append(f"ğŸ† FINAL SCORE: {final_score:.2f}/10")
    output.append("")
    output.append("ğŸ“ˆ VERDICT")
    output.append(f"   {verdict}")
    
    # Add leaderboard
    output.append("")
    output.append(display_leaderboard(leaderboard))
    
    return "\n".join(output)

def main():
    parser = argparse.ArgumentParser(description="Rate latte art photos")
    parser.add_argument("photo", nargs="?", help="Path to photo")
    parser.add_argument("--json", action="store_true", help="Output as JSON")
    parser.add_argument("--name", "-n", help="Name of the barista")
    
    args = parser.parse_args()
    
    if not args.photo:
        # Interactive mode
        print("â˜• Latte Art Rating Skill")
        print("Usage: latte-art-rate <photo_path> [-n 'Barista Name']")
        print("")
        print("Provide a photo path to rate your latte art!")
        
        # Show current leaderboard
        leaderboard = load_leaderboard()
        if leaderboard["entries"]:
            print(display_leaderboard(leaderboard))
        sys.exit(0)
    
    result = rate_photo(args.photo, args.name)
    print(result)

if __name__ == "__main__":
    main()
